#!/usr/bin/env bash

set -euxo pipefail

os=$OS
bin=musd
src=`pwd`
target=$TARGET
dist=$src/dist
version=`git tag --list --sort=version:refname 'v*' | tail -1`

echo "Packaging $bin $version for $target..."

test -f Cargo.lock || cargo generate-lockfile

echo "Building $bin..."

# Fix "musl-gcc: command not found"
if [[ "ubuntu-latest" = $os ]]; then sudo apt install musl-tools -y; fi

case $os in
  ubuntu-latest | macos-latest)
    cargo rustc --bin $bin --target $target --release
    executable=target/$target/release/$bin
    ;;
  windows-latest)
    cargo rustc --bin $bin --target $target --release -- -C target-feature="+crt-static"
    executable=target/$target/release/$bin.exe
    ;;
esac

echo "Copying release files..."
mkdir dist
cp \
  $executable \
  Cargo.lock \
  Cargo.toml \
  LICENSE \
  README.md \
  README.zh-CN.md \
  $dist

cd $dist
echo "Creating release archive..."
case $os in
  ubuntu-latest | macos-latest)
    archive=$dist/$bin-$version-$target.tar.gz
    tar czf $archive *
    echo "::set-output name=archive::$archive"
    ;;
  windows-latest)
    archive=$dist/$bin-$version-$target.zip
    7z a $archive *
    echo "::set-output name=archive::`pwd -W`/$bin-$version-$target.zip"
    ;;
esac
